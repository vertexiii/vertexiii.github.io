<!DOCTYPE html>
<html>
  <head>
    <title>EmulatorJS</title>
    <link
      rel="icon"
      href="docs/favicon.ico"
      sizes="16x16 32x32 48x48 64x64"
      type="image/vnd.microsoft.icon"
    />
    <base href="engine/emulatorjs/">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <style>
      body,
      html {
        height: 100%;
        background-color: black;
        color: white;
      }
      body {
        margin: 0;
        overflow: hidden;
      }
      body,
      #box,
      #top {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }
      #box {
        color: #aaa;
        height: 20em;
        width: 30em;
        max-width: 80%;
        max-height: 80%;
        background-color: #333;
        border-radius: 0.4em;
        border: 2px solid #555;
        position: relative;
        flex-direction: column;
        transition-duration: 0.2s;
        overflow: hidden;
        font-family: monospace;
        font-weight: bold;
        font-size: 20px;
        margin: 5px;
      }
      #box:hover,
      #box[drag] {
        border-color: #38f;
        color: #ddd;
      }
      #input {
        cursor: pointer;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
      }
      #display {
        width: 100%;
        height: 100%;
      }
      select,
      button {
        padding: 0.6em 0.4em;
        margin: 0.5em;
        width: 15em;
        max-width: 100%;
        font-family: monospace;
        font-weight: bold;
        font-size: 16px;
        background-color: #444;
        color: #aaa;
        border-radius: 0.4em;
        border: 1px solid #555;
        cursor: pointer;
        transition-duration: 0.2s;
      }
      select:hover,
      button:hover {
        background-color: #666;
        color: #ddd;
      }
      .logo {
        width: 130px;
        height: 130px;
        filter: drop-shadow(0 0 10px white);
      }
      #top {
        margin: 5px;
      }
    </style>
  </head>
  <body>
    <div id="top">
      <h1>EmulatorJS Demo</h1>
      <img src="docs/Logo-light.png" alt="Logo" class="logo" />
    </div>
    <div id="box">
      <input type="file" id="input" />
      Drag ROM file or click here
    </div>

    <script>
      (async function () {
        let enableDebug = false;
        let enableThreads = false;

        const urlParams = window.frameElement
          ? window.frameElement.getAttribute("data-url").split("#")[1]
          : null;

        async function handleZip(arrayBuffer) {
          const zip = await JSZip.loadAsync(arrayBuffer);
          // Find the first ROM-like file
          const romFile = Object.keys(zip.files).find((f) =>
            /\.(gba|gb|nes|snes|smc|n64|z64|nds)$/i.test(f)
          );
          if (!romFile) throw new Error("No ROM found inside zip");
          const content = await zip.file(romFile).async("blob");
          return URL.createObjectURL(content);
        }

        if (urlParams) {
          let gameUrl = urlParams;

          // Fix protocol slashes
          if (gameUrl.startsWith("https:/") && !gameUrl.startsWith("https://")) {
            gameUrl = gameUrl.replace("https:/", "https://");
          }
          if (gameUrl.startsWith("http:/") && !gameUrl.startsWith("http://")) {
            gameUrl = gameUrl.replace("http:/", "http://");
          }

          let parts = gameUrl.split(".");
          let ext = parts.pop().toLowerCase();

          // Handle ZIPs specially
          if (ext === "zip") {
            const response = await fetch(gameUrl);
            const arrayBuffer = await response.arrayBuffer();
            gameUrl = await handleZip(arrayBuffer);
            // Update extension based on extracted file
            parts.push("gba"); // fallback, could detect from handleZip() filename
            ext = "gba";
          }

          const core = await (async (ext) => {
            if (["fds", "nes", "unif", "unf"].includes(ext)) return "nes";
            if (
              ["smc", "fig", "sfc", "gd3", "gd7", "dx2", "bsx", "swc"].includes(ext)
            )
              return "snes";
            if (["z64", "n64"].includes(ext)) return "n64";
            if (["pce"].includes(ext)) return "pce";
            if (["ngp", "ngc"].includes(ext)) return "ngp";
            if (["ws", "wsc"].includes(ext)) return "ws";
            if (["col", "cv"].includes(ext)) return "coleco";
            if (["d64"].includes(ext)) return "vice_x64sc";
            if (["nds", "gba", "gb", "z64", "n64"].includes(ext)) return ext;
            return "gba"; // fallback
          })(ext);

          const div = document.createElement("div");
          const sub = document.createElement("div");
          const script = document.createElement("script");

          sub.id = "game";
          div.id = "display";

          const top = document.getElementById("top");
          top.remove();
          box.remove();
          div.appendChild(sub);
          document.body.appendChild(div);

          window.EJS_player = "#game";
          window.EJS_gameName = parts.shift();
          window.EJS_biosUrl = "";
          window.EJS_gameUrl = gameUrl;
          window.EJS_core = core;
          window.EJS_pathtodata = "data/";
          window.EJS_startOnLoaded = true;
          window.EJS_DEBUG_XX = enableDebug;
          window.EJS_disableDatabases = true;
          window.EJS_threads = enableThreads;

          script.src = "data/loader.js";
          document.body.appendChild(script);
        }
      })();
    </script>
  </body>
</html>
